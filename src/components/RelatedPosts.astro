---
interface Props {
  currentSlug: string;
  currentTags: string[];
  currentCategory: string;
}

const { currentSlug, currentTags = [], currentCategory } = Astro.props;

// Get all posts
const postsGlob = import.meta.glob('../data/blog-posts/*.md', { eager: true });
const posts = Object.entries(postsGlob).map(([path, post]: [string, any]) => ({
  ...post,
  file: path,
  slug: path.split('/').pop()?.split('.').shift() || ''
}));

// Filter out current post and find related posts
const relatedPosts = posts
  .filter(post => post.slug !== currentSlug)
  .map(post => {
    let score = 0;
    const postTags = post.frontmatter?.tags || [];
    const postCategory = post.frontmatter?.category || '';

    // Score by matching category
    if (postCategory && postCategory === currentCategory) {
      score += 3;
    }

    // Score by matching tags
    const matchingTags = currentTags.filter((tag: string) => postTags.includes(tag));
    score += matchingTags.length;

    return { ...post, score };
  })
  .filter(post => post.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 3); // Show top 3 related posts
---

{relatedPosts.length > 0 && (
  <section class="related-posts">
    <h2>Related Posts</h2>
    <div class="related-posts-grid">
      {relatedPosts.map((post) => {
        const href = `/blog/${post.slug}`;
        return (
          <article class="related-post">
            <h3>
              <a href={href}>{post.frontmatter.title}</a>
            </h3>
            <p>{post.frontmatter.description}</p>
          </article>
        );
      })}
    </div>
  </section>
)}

<style>
  .related-posts {
    margin-top: 4em;
    padding-top: 2em;
    border-top: 1px solid var(--text-secondary);
  }

  .related-posts h2 {
    font-family: var(--font-family-sans);
    font-size: 1.5em;
    font-weight: 700;
    margin-bottom: 1.5em;
  }

  .related-posts-grid {
    display: grid;
    gap: 2em;
  }

  .related-post h3 {
    font-family: var(--font-family-sans);
    font-size: 1.2em;
    font-weight: 700;
    margin: 0 0 0.5em 0;
  }

  .related-post h3 a {
    text-decoration: none;
    color: var(--text-main);
  }

  .related-post h3 a:hover {
    color: var(--primary-color);
  }

  .related-post p {
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text-secondary);
    margin: 0;
  }
</style>
